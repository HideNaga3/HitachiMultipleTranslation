# CIDコードの文字化について

## 質問：CIDコードを文字化できるか？

**回答：理論的には可能だが、実用的には困難**

---

## CIDコードとは

CID = Character ID（文字ID）

PDFフォント内部で使用される文字の識別番号です。

例：
```
元の文字: ា（クメール語の母音記号）
CIDコード: (cid:640)
```

---

## なぜCIDコードが発生するのか

1. **pdfplumberの制限**
   - PDFから文字を抽出する際、フォントのエンコーディング情報を完全に解釈できない
   - 特殊文字（ダイアクリティカルマーク）をUnicodeに変換できず、CIDとして出力

2. **発生箇所**
   - クメール語のダイアクリティカルマーク（母音記号・声調記号）
   - タイ語の声調記号
   - 一部の特殊記号

---

## CIDコードを文字化する方法

### 方法1: PDFフォント情報から手動マッピング（理論上可能）

**手順：**
```python
import pdfplumber

with pdfplumber.open('document.pdf') as pdf:
    page = pdf.pages[0]

    # フォント情報を取得
    for font_name, font_obj in page.fonts.items():
        # CIDからUnicodeへのマッピングを取得
        # （実際にはフォントの内部構造を解析する必要がある）
```

**問題点：**
- PDFのフォント内部構造は複雑
- pdfplumberはこのマッピング情報を直接提供していない
- フォントごとに異なるため、汎用的な解決策にならない

---

### 方法2: 元のPDFと目視で比較して手動修正（現実的）

**手順：**
1. CIDコードが含まれる単語をリストアップ（22件）
2. 元のPDFを開いて該当箇所を確認
3. 正しい文字をコピー＆ペースト
4. CSVを更新

**メリット：**
- 確実に正しい文字を取得できる
- 件数が少ない（22件、4.3%）ので手動でも現実的

**デメリット：**
- 手作業が必要
- 時間がかかる

---

### 方法3: OCR（光学文字認識）を使用

**手順：**
1. PDFをイメージに変換
2. OCRエンジン（Tesseract等）でクメール語を認識
3. OCR結果とpdfplumberの結果を比較
4. CIDコード部分をOCR結果で置換

**問題点：**
- OCRの精度が100%ではない
- クメール語のOCR精度は言語によって異なる
- 新たなエラーが発生する可能性

---

### 方法4: PyMuPDFを使用（試した結果）

**期待：** PyMuPDFはCIDコードを生成しない

**結果：**
- ✓ CIDコードは生成しない
- × Unicode文字コードが誤っている
- × 逆翻訳の精度が低い

**例：**
```
pdfplumber: ការហ្វឹកហ្វឺនជំនាញ → スキルトレーニング ✓
PyMuPDF   : ករា ហវឹ្កហវឺ្នជំនញា → 意味不明 ×
```

---

## 現状での最善策

### 推奨アプローチ

**pdfplumberを使用し、CIDコード22件のみ手動修正**

**理由：**
1. pdfplumberの方が意味的に正確（78.4%の不一致は表記の違いのみ）
2. CIDコード問題は22件（4.3%）のみ
3. 手動修正が最も確実

**手順：**

#### ステップ1: CIDコード含有データを抽出

```bash
# 既に作成済み
output\不一致データ_pdfplumber_vs_pymupdf.csv
```

CIDコードを含む行をフィルター：
```python
import pandas as pd
import re

df = pd.read_csv('output/全言語統合_テンプレート_インポート用.csv', encoding='utf-8-sig')
cid_pattern = r'\(cid:\d+\)'

# CIDコードを含む行を抽出
cid_rows = df[df['km'].astype(str).str.contains(cid_pattern, regex=True, na=False)]

print(f"CIDコードを含む行: {len(cid_rows)}件")
cid_rows.to_csv('output/CIDコード含有データ.csv', index=False, encoding='utf-8-sig')
```

#### ステップ2: 元のPDFと照合して修正

1. `CIDコード含有データ.csv`を開く
2. 各行について：
   - 元のPDF（カンボジア語_げんばのことば.pdf）を開く
   - 該当ページを確認
   - 正しいクメール語をコピー
   - CSVに貼り付け

#### ステップ3: 修正データをマージ

```python
# 修正したCIDデータを読み込む
cid_fixed = pd.read_csv('output/CIDコード修正済み.csv', encoding='utf-8-sig')

# 元のデータと結合
original_df = pd.read_csv('output/全言語統合_テンプレート_インポート用.csv', encoding='utf-8-sig')

# 修正データで置換
for idx, row in cid_fixed.iterrows():
    ja = row['ja']
    fixed_km = row['km_修正後']
    original_df.loc[original_df['ja'] == ja, 'km'] = fixed_km

# 保存
original_df.to_csv('output/全言語統合_CID修正版.csv', index=False, encoding='utf-8-sig')
```

---

## CIDコード一覧（参考）

**カンボジア語で発見されたCIDコード：**
```
(cid:544)  - ダイアクリティカルマーク
(cid:564)  - ダイアクリティカルマーク
(cid:630)  - 母音記号
(cid:640)  - 母音記号
(cid:645)  - 母音記号
(cid:671)  - ダイアクリティカルマーク
(cid:688)  - 子音
(cid:717)  - ダイアクリティカルマーク
(cid:814)  - ダイアクリティカルマーク
(cid:819)  - ダイアクリティカルマーク
(cid:822)  - ダイアクリティカルマーク
(cid:843)  - ダイアクリティカルマーク
```

---

## 代替案：現状のまま使用

**CIDコードがあっても問題ない場合：**

- 表示上の問題（一部文字が欠ける）だけで、人間が読めば意味は推測できる
- システムが表示のみで検索等をしない
- 今後手動で修正する予定

**この場合：**
現状のpdfplumberデータをそのまま使用し、必要に応じて後から修正

---

## まとめ

| 方法 | メリット | デメリット | 推奨度 |
|------|---------|-----------|--------|
| pdfplumber + 手動修正 | 確実、22件のみ | 手作業 | ★★★★★ |
| PyMuPDF | CIDなし | 意味が不正確 | ★☆☆☆☆ |
| OCR | 自動化可能 | 精度不安定 | ★★☆☆☆ |
| フォント解析 | 理論上完璧 | 実装困難 | ★☆☆☆☆ |

**結論：pdfplumberのデータを使用し、CIDコード22件を手動修正するのが最善**

---

## 次のステップ

1. CIDコード含有データを抽出するスクリプトを実行
2. 元のPDFと照合して手動修正
3. 修正後のデータをマージ
4. 最終的なインポート用CSVを作成

手動修正が必要な場合、サポートします。
